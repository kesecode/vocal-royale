#!/usr/bin/env sh

# Fehler manuell behandeln, damit wir saubere Meldungen ausgeben kÃ¶nnen
set -u

# Ins app-Verzeichnis wechseln
cd "$(git rev-parse --show-toplevel)/app"

echo "ğŸ” Pre-commit: app/"

# 1) Nur laufen lassen, wenn in app/ relevante Dateien gestaged sind
STAGED_MATCHING_FILES="$(git diff --name-only --cached -- \
  'src/**' \
  '**/*.svelte' '**/*.ts' '**/*.js' '**/*.tsx' '**/*.jsx' \
  '**/*.json' '**/*.css' '**/*.md' \
  | tr -d '\r')"

if [ -z "$STAGED_MATCHING_FILES" ]; then
  echo "âœ… Keine relevanten Dateien in app/ gestaged â€“ Ã¼berspringe lint-staged."
else
  echo "ğŸ§¹ lint-staged lÃ¤uftâ€¦"
  if ! npx lint-staged --quiet; then
    echo "âŒ lint-staged hat Fehler gemeldet. Commit abgebrochen."
    exit 1
  fi
fi

# 2) VollstÃ¤ndiger Check Ã¼ber die App (wie in CI) â€“ Output LIVE anzeigen
echo "ğŸ§ª npm run lint (vollstÃ¤ndiger Check)â€¦"
if ! npm run lint; then
  echo "âŒ Lint-Check fehlgeschlagen. Commit abgebrochen."
  exit 1
fi

echo "âœ… Alles sauber. Commit kann erstellt werden."